
@{
    ViewBag.Title = "Live";
    Layout = "~/Views/Shared/_LiveLayoutPage.cshtml";
}

<div>
    <div class="row">
       
        <div class="col-lg-9">
            <h2 class="heading">Live </h2>
            <div id="gameTable">
                <table class="table table-condensed">
                    <thead>
                        <tr>
                            <th>Match No</th>
                            <th>Min</th>
                            <th>Home</th>
                            <th>Score</th>
                            <th>Away</th>
                            <th style="padding-bottom: 0px;">
                                <table>
                                    <thead>
                                        <tr><td colspan="3" class="text-center">Full&nbsp;Time</td></tr>
                                        <tr>
                                            <td class="text-center" style="width: 55px;">
                                                1
                                            </td>
                                            <td class="text-center" style="width: 55px;">X</td>
                                            <td class="text-center" style="width: 55px;">2</td>
                                        </tr>
                                    </thead>
                                </table>
                            </th>
                            <th style="padding-bottom: 0px;"><table><thead><tr><td colspan="3">@*Under&nbsp;&nbsp; Over*@</td></tr><tr><td class="text-center" style="width: 55px;"><i class="fa fa-sort-down fa-2x"></i></td><td class="text-center" style="width: 31px;">@*extra value*@</td><td class="text-center" style="width: 55px;"><i class="fa fa-sort-up fa-2x"></i></td></tr></thead></table></th>

                        </tr>
                    </thead>
                    <tbody id="tbody">
                        @*<tr class="loading text-center"><td colspan="11">loading...</td></tr>*@
                       
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-lg-3">

        </div>
    </div>
</div>

@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.1.2.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        (function ($) {

            $.fn.extend({

                addTemporaryClass: function (className, duration) {
                    var elements = this;
                    setTimeout(function () {
                        elements.removeClass(className);
                    }, duration);

                    return this.each(function () {
                        $(this).addClass(className);
                    });
                }
            });

        })(jQuery);
        
        $(function () {
            // A simple templating method for replacing placeholders enclosed in curly braces.
            if (!String.prototype.supplant) {
                String.prototype.supplant = function (o) {
                    return this.replace(/{([^{}]*)}/g,
                        function (a, b) {
                            var r = o[b];
                            return typeof r === 'string' || typeof r === 'number' ? r : a;
                        }
                    );
                };
            }

            $(function () {

                var ticker = $.connection.liveBetHub,
                    $gameTable = $('#gameTable'),
                    $gamesTableBody = $gameTable.find('#tbody');
                


                function init() {
                    ticker.server.testString().done(function (string) {
                        console.log(string);
                    });

                    // get all livescores
                    ticker.server.getAllGames().done(function (games) {
                        $gamesTableBody.empty();
                        console.log(games);
                        $.each(games, function () {
                            
                            var game = this;
                            console.log(game);
                            if (game.FullTimeOdds == null) {
                                game.FullTimeOdds = {
                                    AwayWins: "N/A",
                                    Draw: "N/A",
                                    HomeWins: "N/A"
                                };
                            }

                            if (game.UnderOverOdds == null) {
                                game.UnderOverOdds = {
                                    Under: "N/A",
                                    Over: "N/A",
                                    ExtraValue: "N/A"
                                };
                            }
                            var rowTemplate =
                                '<tr id="' + game.MatchNo + '">' +
                                    '<td>' + game.MatchNo + '</td>' +
                                    '<td>' + game.Minutes + '</td>' +
                                    '<td>' + game.LocalTeam + '</td>' +
                                    '<td>' + game.LocalTeamScore + ' - ' + game.AwayTeamScore + '</td>' +
                                    '<td>' + game.AwayTeam + '</td>' +
                                    '<td style="padding-bottom: 0px;">' +
                                    '<table class="fullTimeOdds"><tbody><tr><td style="border-top-width: 0px;" > ' +
                                    '<input type="button" class="btn btn-sm btn-default  FT-1" value="' + game.FullTimeOdds.HomeWins + '"/>' + '</td>' +
                                    '<td style="border-top-width: 0px;">' +
                                    '<input type="button" class="btn btn-sm btn-default  FT-X" value="' + game.FullTimeOdds.Draw + '"/></td>' +
                                    '<td style="border-top-width: 0px;"><input type="button" class="btn btn-sm btn-default  FT-2" value="' + game.FullTimeOdds.AwayWins + '"/>' +
                                    '</td></tr></tbody></table></td><td style="padding-bottom: 0px;">' +
                                    '<table class="underOverOdds">' +
                                    '<tbody>' +
                                    '<tr>' +
                                    '<td style="border-top-width: 0px;">' +
                                    '<input type="button" class="btn btn-sm btn-default" value="' + game.UnderOverOdds.Under + '"/></td>' +
                                    '<td style="border-top-width: 0px;padding-top: 10px;"> ' +
                                    ' <span class="text-info">' + game.UnderOverOdds.ExtraValue + '</span>' +
                                    '</td><td style="border-top-width: 0px;">' +
                                    '<input type="button" class="btn btn-sm btn-default" value="' + game.UnderOverOdds.Over + '"/>' +
                                    '</td></tr></tbody></table></td></tr>';
                            $gamesTableBody.append(rowTemplate);
                        });
                    });
                }

                // Add a client-side hub method that the server will call
                ticker.client.updateGame = function (game) {
                    console.clear();
                    //console.log(game);
                    if (game.FullTimeOdds == null) {
                        game.FullTimeOdds = {
                            AwayWins: "N/A",
                            Draw: "N/A",
                            HomeWins: "N/A"
                        };
                    }

                    if (game.UnderOverOdds == null) {
                        game.UnderOverOdds = {
                            Under: "N/A",
                            Over: "N/A",
                            ExtraValue: "N/A"
                        };
                    }
                    var rowTemplate = '<tr id="' + game.MatchNo + '">' +
                        '<td>' + game.MatchNo + '</td>' +
                        '<td>' + game.Minutes + '</td>' +
                        '<td>' + game.LocalTeam + '</td>' +
                        '<td>' + game.LocalTeamScore + ' - ' + game.AwayTeamScore + '</td>' +
                        '<td>' + game.AwayTeam + '</td>' +
                        '<td style="padding-bottom: 0px;">' +
                        '<table class="fullTimeOdds">' +
                        '<tbody>' +
                        '<tr>' +
                        '<td style="border-top-width: 0px;" > ' +
                        '<input type="button" class="btn btn-sm btn-default FT-1" value="' + game.FullTimeOdds.HomeWins + '"/>' +
                        '</td>' +
                        '<td style="border-top-width: 0px;">' +
                        '<input type="button" class="btn btn-sm btn-default FT-X" value="' + game.FullTimeOdds.Draw + '"/>' +
                        '</td>' +
                        '<td style="border-top-width: 0px;">' +
                        '<input type="button" class="btn btn-sm btn-default FT-2" value="' + game.FullTimeOdds.AwayWins + '"/>' +
                        '</td>' +
                        '</tr>' +
                        '</tbody>' +
                        '</table>' +
                        '</td>' +
                        '<td style="padding-bottom: 0px;">' +
                        '<table class="underOverOdds">' +
                        '<tbody>' +
                        '<tr>' +
                        '<td style="border-top-width: 0px;">' +
                        '<input type="button" class="btn btn-sm btn-default" value="' + game.UnderOverOdds.Under + '"/>' +
                        '</td>' +
                        '<td style="border-top-width: 0px;padding-top: 10px;">' +
                        '  <span class="text-info ">' + game.UnderOverOdds.ExtraValue + '</span>' +
                        '</td>' +
                        '<td style="border-top-width: 0px;">' +
                        '<input type="button" class="btn btn-sm btn-default" value="' + game.UnderOverOdds.Over + '"/>' +
                        '</td>' +
                        '</tr>' +
                        '</tbody>' +
                        '</table>' +
                        '</td>' +
                        '</tr>';
                    var tr = $gamesTableBody.find('tr[id=' + game.MatchNo + ']').children('td');//.eq(0).text();
                    var table = $('#' + game.MatchNo).html();
                    var FT1 = $gamesTableBody.find('#' + game.MatchNo + ' > td > table.fullTimeOdds > tbody tr > td > input.FT-1').attr("value");
                    var FTX = $gamesTableBody.find('#' + game.MatchNo + ' > td > table.fullTimeOdds > tbody tr > td > input.FT-X').attr("value");
                    var FT2 = $gamesTableBody.find('#' + game.MatchNo + ' > td > table.fullTimeOdds > tbody tr > td > input.FT-2').attr("value");
                   
                    if ($gamesTableBody.find('tr[id=' + game.MatchNo + ']').length > 0) {
                        $gamesTableBody.find('tr[id=' + game.MatchNo + ']')
                            .replaceWith(rowTemplate);
                    } else {
                        $gamesTableBody.append(rowTemplate);
                    }
                    if (parseInt(FT1) > parseInt(game.FullTimeOdds.HomeWins)) {
                        $('#' + game.MatchNo + ' > td > table.fullTimeOdds > tbody tr > td > input.FT-1').addTemporaryClass("down", 3000);

                    }
                    if (parseInt(FT1) < parseInt(game.FullTimeOdds.HomeWins)) {
                        $('#' + game.MatchNo + ' > td > table.fullTimeOdds > tbody tr > td > input.FT-1').addTemporaryClass("up", 3000);
                    }
                    if (parseInt(FTX) > parseInt(game.FullTimeOdds.Draw)) {
                        $('#' + game.MatchNo + ' > td > table.fullTimeOdds > tbody tr > td > input.FT-X').addTemporaryClass("down", 3000);
                        console.log(FT1 + ' ' + FTX + ' ' + FT2 + ' down');

                    }
                    if (parseInt(FTX) < parseInt(game.FullTimeOdds.Draw)) {
                        $('#' + game.MatchNo + ' > td > table.fullTimeOdds > tbody tr > td > input.FT-X').addTemporaryClass("up", 3000);
                        console.log(FT1 + ' ' + FTX + ' ' + FT2 + ' up');
                    }
                    if (parseInt(FTX) > parseInt(game.FullTimeOdds.AwayWins)) {
                        $('#' + game.MatchNo + ' > td > table.fullTimeOdds > tbody tr > td > input.FT-2').addTemporaryClass("down", 3000);
                        console.log(FT1 + ' ' + FTX + ' ' + FT2 + ' down');

                    }
                    if (parseInt(FTX) < parseInt(game.FullTimeOdds.AwayWins)) {
                        $('#' + game.MatchNo + ' > td > table.fullTimeOdds > tbody tr > td > input.FT-2').addTemporaryClass("up", 3000);
                        console.log(FT1 + ' ' + FTX + ' ' + FT2 + ' up');
                    }

                };
                // Start the connection
                $.connection.hub.start().done(init);

            });
        })

    </script>}