
@{
    ViewBag.Title = "Live";
    Layout = "~/Views/Shared/_LiveLayoutPage.cshtml";
}
<div>
    <div class="row">

        <div class="col-lg-9">
            <h2>Live </h2>
            <div id="gameTable">
                <table class="table table-condensed">
                    <thead>
                        <tr>
                            <th>Match No</th>
                            <th>Min</th>
                            <th>Home</th>
                            <th>Score</th>
                            <th>Away</th>
                            <th style="padding-bottom: 0px;">
                                <table>
                                    <thead>
                                        <tr><td colspan="3" class="text-center">Full&nbsp;Time</td></tr>
                                        <tr>
                                            <td class="text-center" style="width: 55px;">
                                                1
                                            </td>
                                            <td class="text-center" style="width: 55px;">X</td>
                                            <td class="text-center" style="width: 55px;">2</td>
                                        </tr>
                                    </thead>
                                </table>
                            </th>
                            <th style="padding-bottom: 0px;"><table><thead><tr><td colspan="3">@*Under&nbsp;&nbsp; Over*@</td></tr><tr><td class="text-center" style="width: 55px;"><i class="fa fa-sort-down fa-2x"></i></td><td class="text-center" style="width: 31px;">@*extra value*@</td><td class="text-center" style="width: 55px;"><i class="fa fa-sort-up fa-2x"></i></td></tr></thead></table></th>

                        </tr>
                    </thead>
                    <tbody id="tbody">
                        <tr class="loading"><td colspan="5">loading...</td></tr>
                        @*<tr data-ng-repeat="match in LiveMatches" data-symbol="match.MatchNo">
                                <td>{{match.MatchNo}}</td>
                                <td>{{match.Minutes}}</td>
                                <td>{{match.LocalTeam}}</td>
                                <td>{{match.AwayTeamScore }} + - + {{match.LocalTeamScore}}</td>
                                <td>{{match.AwayTeam}}</td>
                                <td style="padding-bottom: 0px;">
                                    <table>
                                        <tbody>
                                            <tr>
                                                <td style="border-top-width: 0px;">{{match.FullTimeOdds.HomeWins}}</td>
                                                <td style="border-top-width: 0px;">{{match.FullTimeOdds.Draw}}</td>
                                                <td style="border-top-width: 0px;">{{match.FullTimeOdds.AwayWins}}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                                <td style="padding-bottom: 0px;">
                                    <table>
                                        <tbody>
                                            <tr>
                                                <td style="border-top-width: 0px;">{{match.UnderOverOdds.Under}}</td>
                                                <td style="border-top-width: 0px;">{{match.UnderOverOdds.ExtraValue}}</td>
                                                <td style="border-top-width: 0px;"> {{match.UnderOverOdds.Over }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>*@
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-lg-3">

        </div>
    </div>
</div>

@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.1.2.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            // A simple templating method for replacing placeholders enclosed in curly braces.
            if (!String.prototype.supplant) {
                String.prototype.supplant = function (o) {
                    return this.replace(/{([^{}]*)}/g,
                        function (a, b) {
                            var r = o[b];
                            return typeof r === 'string' || typeof r === 'number' ? r : a;
                        }
                    );
                };
            }

            $(function () {

                var ticker = $.connection.liveBetHub,
                    $gameTable = $('#gameTable'),
                    $gamesTableBody = $gameTable.find('#tbody');
                


                function init() {
                    ticker.server.testString().done(function (string) {
                        console.log(string);
                    });

                    // get all livescores
                    ticker.server.getAllGames().done(function (games) {
                        $gamesTableBody.empty();
                        console.log(games);
                        $.each(games, function () {
                            var game = this;
                            if (game.FullTimeOdds == null) {
                                game.FullTimeOdds = {
                                    AwayWins: "N/A",
                                    Draw: "N/A",
                                    HomeWins: "N/A"
                                };
                            }

                            if (game.UnderOverOdds == null) {
                                game.UnderOverOdds = {
                                    Under: "N/A",
                                    Over: "N/A",
                                    ExtraValue: "N/A"
                                };
                            }
                            var rowTemplate = '<tr data-symbol="' + game.MatchNo + '"><td>' + game.MatchNo + '</td><td>' + game.Minutes + '</td><td>' + game.LocalTeam + '</td><td>' + game.AwayTeamScore + ' - ' + game.LocalTeamScore + '</td><td>' + game.AwayTeam + '</td><td style="padding-bottom: 0px;"><table><tbody><tr><td style="border-top-width: 0px;" > <input type="button" class="btn btn-sm btn-default" value="' + game.FullTimeOdds.HomeWins + '"/>' + '</td><td style="border-top-width: 0px;"><input type="button" class="btn btn-sm btn-default" value="' + game.FullTimeOdds.Draw + '"/></td><td style="border-top-width: 0px;"><input type="button" class="btn btn-sm btn-default" value="' + game.FullTimeOdds.AwayWins + '"/></td></tr></tbody></table></td><td style="padding-bottom: 0px;"><table><tbody><tr><td style="border-top-width: 0px;"><input type="button" class="btn btn-sm btn-default" value="' + game.UnderOverOdds.Under + '"/></td><td style="border-top-width: 0px;">  <span class="text-info">' + game.UnderOverOdds.ExtraValue + '</span></td><td style="border-top-width: 0px;"><input type="button" class="btn btn-sm btn-default" value="' + game.UnderOverOdds.Over + '"/></td></tr></tbody></table></td></tr>';
                            $gamesTableBody.append(rowTemplate);
                        });
                    });
                }

                // Add a client-side hub method that the server will call
                ticker.client.updateGame = function (game) {
                    console.clear();
                    console.log(game);
                    if (game.FullTimeOdds == null) {
                        game.FullTimeOdds = {
                            AwayWins: "",
                            Draw: "",
                            HomeWins: ""
                        };
                    }

                    if (game.UnderOverOdds == null) {
                        game.UnderOverOdds = {
                            Under: "",
                            Over: "",
                            ExtraValue: ""
                        };
                    }
                    var rowTemplate = '<tr data-symbol="' + game.MatchNo + '"><td>' + game.MatchNo + '</td><td>' + game.Minutes + '</td><td>' + game.LocalTeam + '</td><td>' + game.AwayTeamScore + ' - ' + game.LocalTeamScore + '</td><td>' + game.AwayTeam + '</td><td style="padding-bottom: 0px;"><table><tbody><tr><td style="border-top-width: 0px;" > <input type="button" class="btn btn-sm btn-default" value="' + game.FullTimeOdds.HomeWins + '"/>' + '</td><td style="border-top-width: 0px;"><input type="button" class="btn btn-sm btn-default" value="' + game.FullTimeOdds.Draw + '"/></td><td style="border-top-width: 0px;"><input type="button" class="btn btn-sm btn-default" value="' + game.FullTimeOdds.AwayWins + '"/></td></tr></tbody></table></td><td style="padding-bottom: 0px;"><table><tbody><tr><td style="border-top-width: 0px;"><input type="button" class="btn btn-sm btn-default" value="' + game.UnderOverOdds.Under + '"/></td><td style="border-top-width: 0px;">  <span class="text-info">' + game.UnderOverOdds.ExtraValue + '</span></td><td style="border-top-width: 0px;"><input type="button" class="btn btn-sm btn-default" value="' + game.UnderOverOdds.Over + '"/></td></tr></tbody></table></td></tr>';

                    if ($gamesTableBody.find('tr[data-symbol=' + game.MatchNo + ']').length > 0) {

                        $gamesTableBody.find('tr[data-symbol=' + game.MatchNo + ']')
                            .replaceWith(rowTemplate);
                    } else {
                        $gamesTableBody.append(rowTemplate);
                    }
                };


                // Start the connection
                $.connection.hub.start().done(init);

            });
        })

    </script>}